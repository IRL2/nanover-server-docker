#!/bin/bash

# build.sh - Build and run the NanoVer Docker container

set -e

echo -e "=== NanoVer Server docker image ===\n"

# Build the Docker image
build() {
	docker build -t nanover-server:latest .
	echo "Docker image built successfully!"
}

# Create necessary directories
if [[ ! -d data || ! -d config || ! -d output ]]; then
	mkdir -p data config output
	echo "Created directories: data, config, output"
fi

# Function to run the container
run_container() {
    echo "Starting NanoVer server container..."
    
    echo "Starting with arguments: $@"
    docker run -it --rm \
        -p 0.0.0.0:8888:8888 \
        -p 0.0.0.0:38801:38801 \
        -p 0.0.0.0:38802:38802 \
        -p 0.0.0.0:54545:54545 \
        -v $(pwd)/data:/app/data \
        -v $(pwd)/config:/app/config \
        -v $(pwd)/output:/app/output \
        nanover-server:latest "$@"
}

# Function to run interactive shell in container
run_shell() {
    echo "Starting interactive shell in NanoVer container..."
    docker run -it --rm \
        -p 0.0.0.0:8888:8888 \
        -p 0.0.0.0:38801:38801 \
        -p 0.0.0.0:38802:38802 \
        -p 0.0.0.0:54545:54545 \
        -v $(pwd)/data:/app/data \
        -v $(pwd)/config:/app/config \
        -v $(pwd)/output:/app/output \
        --entrypoint /bin/bash \
        nanover-server:latest
}

# Function to run with docker-compose
run_compose() {
    echo "Starting with docker-compose..."
    docker-compose up --build
}

# Parse command line arguments
case "${1:-}" in
    "build")
    	build
        # echo "Build completed. Use './build.sh run' to start the server."
        ;;
    "run")
        shift
        run_container "$@"
        ;;
    "shell")
        run_shell
        ;;
    "compose")
        run_compose
        ;;
    "help"|"-h"|"--help"|*)
        echo "Usage: $0 [command] [subcommand + args...]"
        echo ""
        echo "Commands:"
        echo "  shell              (Default) Start an interactive shell in the container"
        echo -e "  run [command...]   Run the NanoVer server using a command:\n\
	demo                  Run nanover server with demo nanotube simulation \n\
	omni [files...]       Run nanover-omni with specified OpenMM XML files \n\
	notebook              Run Jupyter notebook server with tutorials \n\
	notebook --path       Run Jupyter notebook server from the /data path \n\
	help                  Show more help on the commands"
        echo "  build              Build the Docker image only"
        # echo "  compose            Start using docker-compose"
        echo "  help               Show this help message"
        echo ""
        echo "Examples:"
        echo "  $0 run"
        echo "  $0 run demo"
        echo "  $0 run notebook"
        echo "  $0 build"
        echo "  $0 shell"
        # echo "  $0 compose"
        ;;
    # *)
    #     echo "Building and running NanoVer server..."
    #     run_container "$@"
    #     ;;
esac
